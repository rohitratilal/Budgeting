<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MyFinance ‚Äì Personal Budgeting (Single File)</title>
  <!-- Tailwind CDN (for quick styling) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js for charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- React + ReactDOM UMD -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <!-- Babel for in-browser JSX (fine for Pages demos) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    /* Simple scrollbar */
    ::-webkit-scrollbar { height: 8px; width: 10px; }
    ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 8px; }
    ::-webkit-scrollbar-track { background: #f3f4f6; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-b from-indigo-50 via-rose-50 to-white text-zinc-900">
  <div id="root" class="max-w-6xl mx-auto p-4 md:p-8"></div>

  <script type="text/babel">
    const { useState, useMemo, useEffect, useRef } = React;

    // ------------------------------
    // Utils
    // ------------------------------
    const uid = () => Math.random().toString(36).slice(2);
    const todayISO = () => new Date().toISOString().slice(0,10);
    const currencyFmt = (n, c='¬£') => `${c}${Number(n||0).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2})}`;
    const daysInMonth = (y, m) => new Date(y, m, 0).getDate(); // m=1..12

    // CSV helpers
    const sanitizeNote = s => String(s||"").replace(/[\r\n]+/g, ' ');
    const csvEscape = (val) => {
      const s = String(val ?? "");
      return /[",\r\n]/.test(s) ? '"' + s.replace(/"/g,'""') + '"' : s;
    };
    function parseCSVLine(line){
      const out=[]; let cur=""; let inQ=false; for(let i=0;i<line.length;i++){ const ch=line[i];
        if(inQ){ if(ch==='"'){ if(line[i+1]==='"'){ cur+='"'; i++; } else { inQ=false; } } else { cur+=ch; } }
        else { if(ch===','){ out.push(cur); cur=""; } else if(ch==='"'){ inQ=true; } else { cur+=ch; } }
      } out.push(cur); return out;
    }

    // Local storage hook
    function useLocalState(key, initial){
      const [state, setState] = useState(()=>{ try{ const raw=localStorage.getItem(key); return raw?JSON.parse(raw):initial; }catch{return initial;} });
      useEffect(()=>{ try{ localStorage.setItem(key, JSON.stringify(state)); }catch{} },[key,state]);
      return [state, setState];
    }

    // ------------------------------
    // Defaults
    // ------------------------------
    const DEFAULT_GROUPS = [
      { id: uid(), name: 'Essentials', categories: [
        { id: uid(), name: 'Rent', budget: 800 },
        { id: uid(), name: 'Groceries', budget: 250 },
        { id: uid(), name: 'Utilities', budget: 120 },
      ]},
      { id: uid(), name: 'Lifestyle', categories: [
        { id: uid(), name: 'Dining Out', budget: 120 },
        { id: uid(), name: 'Entertainment', budget: 80 },
      ]},
      { id: uid(), name: 'Savings', categories: [
        { id: uid(), name: 'Emergency Fund', budget: 200 },
      ]},
    ];

    const DEFAULT_ACCOUNTS = [
      { id: uid(), name: 'Current Account', type: 'Bank', balance: 2000 },
      { id: uid(), name: 'Savings', type: 'Savings', balance: 5000 },
      { id: uid(), name: 'Credit Card', type: 'Credit', balance: -300 },
    ];

    const DEFAULT_BILLS = [
      { id: uid(), name: 'Rent', amount: 800, dueDay: 1, auto: true },
      { id: uid(), name: 'Electricity', amount: 60, dueDay: 15, auto: false },
    ];

    const DEFAULT_GOALS = [ { id: uid(), name: 'Holiday Fund', target: 1500, saved: 250, deadline: new Date().getFullYear()+'-12-31' } ];

    const DEFAULT_RECURRING = [
      { id: uid(), name: 'Salary', type: 'income', amount: 2000, dayOfMonth: 25, accountId: null, categoryId: null, note: 'Monthly salary', isEnabled: true },
      { id: uid(), name: 'Gym', type: 'expense', amount: 25, dayOfMonth: 5, accountId: null, categoryId: null, note: 'Membership', isEnabled: true },
    ];

    // ------------------------------
    // App
    // ------------------------------
    function App(){
      const [profile, setProfile] = useLocalState('mf_profile', { name:'You', currency:'¬£', month:new Date().toISOString().slice(0,7) });
      const [groups, setGroups] = useLocalState('mf_groups', DEFAULT_GROUPS);
      const [accounts, setAccounts] = useLocalState('mf_accounts', DEFAULT_ACCOUNTS);
      const [transactions, setTransactions] = useLocalState('mf_txns', []);
      const [bills, setBills] = useLocalState('mf_bills', DEFAULT_BILLS);
      const [goals, setGoals] = useLocalState('mf_goals', DEFAULT_GOALS);
      const [recurring, setRecurring] = useLocalState('mf_recurring', DEFAULT_RECURRING);
      const [tab, setTab] = useState('dashboard');

      const monthKey = profile.month; // YYYY-MM
      const monthTxns = useMemo(()=> transactions.filter(t => (t.date||'').slice(0,7)===monthKey), [transactions, monthKey]);
      const monthIncome = useMemo(()=> monthTxns.filter(t=>t.type==='income').reduce((a,b)=>a+Number(b.amount),0), [monthTxns]);
      const monthExpense = useMemo(()=> monthTxns.filter(t=>t.type==='expense').reduce((a,b)=>a+Number(b.amount),0), [monthTxns]);

      // category spend map
      const categorySpend = useMemo(()=>{
        const map={};
        for(const g of groups){ for(const c of g.categories){ map[c.id]={ name:c.name, budget:Number(c.budget||0), spent:0 }; } }
        for(const t of monthTxns.filter(t=>t.type==='expense' && t.categoryId)){
          if(map[t.categoryId]) map[t.categoryId].spent += Number(t.amount);
        }
        return Object.values(map);
      },[groups, monthTxns]);

      const warnings = useMemo(()=>{
        const arr=[]; categorySpend.forEach(c=>{
          if(c.spent > c.budget && c.budget>0) arr.push(`${c.name} is over budget by ${currencyFmt(c.spent-c.budget, profile.currency)}`);
          else if(c.budget>0 && c.spent > 0.9*c.budget) arr.push(`${c.name} is nearing its budget`);
        }); return arr; },[categorySpend, profile.currency]);

      // Net worth series (12 months)
      const netWorthSeries = useMemo(()=>{
        const months=[]; const start=new Date(); start.setMonth(start.getMonth()-11);
        const base = accounts.reduce((a,b)=>a+Number(b.balance||0),0);
        let running = base;
        for(let i=0;i<12;i++){
          const d=new Date(start.getFullYear(), start.getMonth()+i, 1);
          const key=d.toISOString().slice(0,7);
          const delta = transactions.filter(t=> (t.date||'').slice(0,7)===key)
            .reduce((a,b)=> a + (b.type==='income'?Number(b.amount):-Number(b.amount)), 0);
          running += delta;
          months.push({ label: d.toLocaleString(undefined,{month:'short', year:'numeric'}), value: Number(running.toFixed(2)) });
        }
        return months;
      },[accounts, transactions]);

      // Recurring materialization when month changes or recurring rules change
      useEffect(()=>{ materializeRecurring(monthKey); }, [monthKey, JSON.stringify(recurring)]);
      function materializeRecurring(key){
        const [y,m] = key.split('-').map(Number); const dim = daysInMonth(y,m);
        const toAdd=[];
        recurring.filter(r=>r.isEnabled).forEach(r=>{
          const day=Math.min(Math.max(1, Number(r.dayOfMonth||1)),31);
          const actual = Math.min(day, dim);
          const date = `${key}-${String(actual).padStart(2,'0')}`;
          const exists = transactions.some(t => t.meta?.recurringId===r.id && (t.date||'').slice(0,10)===date);
          if(!exists){ toAdd.push({ id:uid(), date, type:r.type, amount:Number(r.amount||0), accountId:r.accountId||undefined, categoryId:r.categoryId||undefined, note:r.note||r.name, meta:{recurringId:r.id} }); }
        });
        if(toAdd.length) setTransactions(prev=>[...toAdd, ...prev]);
      }

      // CRUD helpers
      const addTxn = (txn)=> setTransactions(prev=> [{id:uid(), ...txn}, ...prev]);
      const delTxn = (id)=> setTransactions(prev=> prev.filter(t=>t.id!==id));

      const addAccount = (a)=> setAccounts(prev=> [...prev, {id:uid(), balance:0, ...a}]);
      const delAccount = (id)=> setAccounts(prev=> prev.filter(a=>a.id!==id));

      const addGroup = (name)=> setGroups(prev=> [...prev, {id:uid(), name, categories:[]}]);
      const addCategory = (groupId, name, budget=0)=> setGroups(prev=> prev.map(g=> g.id===groupId? {...g, categories:[...g.categories, {id:uid(), name, budget:Number(budget)}]}:g));
      const updateCategoryBudget = (catId, budget)=> setGroups(prev=> prev.map(g=> ({...g, categories:g.categories.map(c=> c.id===catId? {...c, budget:Number(budget)}:c)})));
      const delCategory = (catId)=> setGroups(prev=> prev.map(g=> ({...g, categories:g.categories.filter(c=>c.id!==catId)})));

      const addBill = (b)=> setBills(prev=> [...prev, {id:uid(), ...b}]);
      const delBill = (id)=> setBills(prev=> prev.filter(b=>b.id!==id));

      const addGoal = (g)=> setGoals(prev=> [...prev, {id:uid(), ...g}]);
      const updateGoal = (id, patch)=> setGoals(prev=> prev.map(x=> x.id===id? {...x, ...patch}:x));
      const delGoal = (id)=> setGoals(prev=> prev.filter(x=>x.id!==id));

      const addRecurring = (r)=> setRecurring(prev=> [...prev, { id:uid(), isEnabled:true, ...r }]);
      const updateRecurring = (id, patch)=> setRecurring(prev=> prev.map(x=> x.id===id? {...x, ...patch}:x));
      const delRecurring = (id)=> setRecurring(prev=> prev.filter(x=>x.id!==id));

      // CSV Export/Import
      function exportCSV(){
        const rows = [
          ['id','date','type','amount','accountId','categoryId','note'],
          ...transactions.map(t=> [t.id, t.date, t.type, t.amount, t.accountId||'', t.categoryId||'', sanitizeNote(t.note)])
        ];
        const csv = rows.map(r=> r.map(csvEscape).join(',')).join('\n');
        const blob = new Blob([csv], {type:'text/csv'}); const url = URL.createObjectURL(blob);
        const a=document.createElement('a'); a.href=url; a.download='myfinance-transactions.csv'; a.click(); URL.revokeObjectURL(url);
      }
      async function importCSV(file){
        const text = await file.text();
        const lines = text.split(/\r?\n/).filter(Boolean);
        if(!lines.length) return;
        const cols = parseCSVLine(lines[0]); const idx = (k)=> cols.indexOf(k);
        const parsed = lines.slice(1).map(line=>{ const p=parseCSVLine(line); return {
          id: p[idx('id')] || uid(),
          date: p[idx('date')] || todayISO(),
          type: p[idx('type')] || 'expense',
          amount: Number(p[idx('amount')]||0),
          accountId: p[idx('accountId')] || undefined,
          categoryId: p[idx('categoryId')] || undefined,
          note: p[idx('note')] || ''
        };});
        setTransactions(prev=> [...parsed, ...prev]);
      }

      // Charts via Chart.js
      function NetWorthChart({data}){
        const ref = useRef(null); const chartRef = useRef(null);
        useEffect(()=>{
          if(!ref.current) return;
          if(chartRef.current) chartRef.current.destroy();
          const ctx = ref.current.getContext('2d');
          chartRef.current = new Chart(ctx, {
            type:'line',
            data:{ labels:data.map(d=>d.label), datasets:[{ label:'Net Worth', data:data.map(d=>d.value), fill:true, tension:0.3 }] },
            options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}} }
          });
          return ()=>{ if(chartRef.current) chartRef.current.destroy(); };
        },[JSON.stringify(data)]);
        return <canvas ref={ref} className="w-full h-64"></canvas>;
      }

      function BarChart({rows}){
        const ref = useRef(null); const chartRef = useRef(null);
        useEffect(()=>{
          if(!ref.current) return;
          if(chartRef.current) chartRef.current.destroy();
          const ctx = ref.current.getContext('2d');
          chartRef.current = new Chart(ctx, {
            type:'bar',
            data:{ labels: rows.map(r=>r.name), datasets:[
              { label:'Spent', data: rows.map(r=>r.spent) },
              { label:'Budget', data: rows.map(r=>r.budget) }
            ]},
            options:{ responsive:true, maintainAspectRatio:false, scales:{ x:{ticks:{maxRotation:45, minRotation:0}}} }
          });
          return ()=>{ if(chartRef.current) chartRef.current.destroy(); };
        },[JSON.stringify(rows)]);
        return <canvas ref={ref} className="w-full h-64"></canvas>;
      }

      // Small Controls
      function TextInput({label, value, onChange, type='text', ...props}){
        return (
          <label className="block text-sm">
            <span className="text-zinc-700">{label}</span>
            <input type={type} value={value} onChange={e=>onChange(e.target.value)} {...props}
              className="mt-1 w-full rounded-md border border-zinc-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" />
          </label>
        );
      }
      function SelectInput({label, value, onChange, options}){
        return (
          <label className="block text-sm">
            <span className="text-zinc-700">{label}</span>
            <select value={value} onChange={e=>onChange(e.target.value)}
              className="mt-1 w-full rounded-md border border-zinc-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
              {options.map(o=> <option key={o.value} value={o.value}>{o.label}</option>)}
            </select>
          </label>
        );
      }
      function Btn({children, onClick, variant='solid'}){
        const cls = variant==='solid'
          ? 'bg-indigo-600 hover:bg-indigo-700 text-white'
          : 'border border-zinc-300 hover:bg-zinc-50';
        return <button onClick={onClick} className={`px-3 py-2 rounded-md text-sm ${cls}`}>{children}</button>
      }

      // Add Transaction Dialog (simple inline)
      function AddTxn({onAdd}){
        const [date, setDate] = useState(todayISO());
        const [type, setType] = useState('expense');
        const [amount, setAmount] = useState('');
        const [accountId, setAccountId] = useState(accounts[0]?.id || '');
        const [categoryId, setCategoryId] = useState('');
        const [note, setNote] = useState('');
        return (
          <div className="grid md:grid-cols-5 gap-2">
            <TextInput label="Date" type="date" value={date} onChange={setDate} />
            <SelectInput label="Type" value={type} onChange={setType} options={[{value:'income',label:'Income'},{value:'expense',label:'Expense'}]} />
            <TextInput label="Amount" type="number" value={amount} onChange={setAmount} />
            <SelectInput label="Account" value={accountId} onChange={setAccountId} options={[...accounts.map(a=>({value:a.id,label:a.name}))]} />
            <SelectInput label="Category (opt)" value={categoryId} onChange={setCategoryId} options={[{value:'',label:'‚Äî'}].concat(groups.flatMap(g=>g.categories.map(c=>({value:c.id,label:`${g.name} ‚Ä¢ ${c.name}`}))))} />
            <div className="md:col-span-4"><TextInput label="Note (opt)" value={note} onChange={setNote} /></div>
            <div className="md:col-span-1 flex items-end"><Btn onClick={()=>{ onAdd({date, type, amount:Number(amount||0), accountId, categoryId:categoryId||undefined, note}); setAmount(''); setNote(''); }}>Add</Btn></div>
          </div>
        );
      }

      // TABS CONTENT
      function Dashboard(){
        const leftToBudget = Math.max(0, monthIncome - categorySpend.reduce((a,b)=>a+b.budget,0));
        return (
          <div className="space-y-4">
            <div className="grid md:grid-cols-4 gap-4">
              <Card title="Income (month)" value={currencyFmt(monthIncome, profile.currency)} color="from-emerald-500 to-teal-600" />
              <Card title="Expenses (month)" value={currencyFmt(monthExpense, profile.currency)} color="from-rose-500 to-pink-600" />
              <Card title="Left to Budget" value={currencyFmt(leftToBudget, profile.currency)} color="from-sky-500 to-indigo-600" />
              <Card title="Net Worth" value={currencyFmt(accounts.reduce((a,b)=>a+Number(b.balance||0),0)+transactions.reduce((a,b)=> a + (b.type==='income'?Number(b.amount):-Number(b.amount)),0), profile.currency)} color="from-violet-500 to-fuchsia-600" />
            </div>

            {warnings.length>0 && (
              <div className="p-3 rounded-md border border-amber-300 bg-amber-50 text-sm">
                <div className="font-medium mb-1">‚ö†Ô∏è Overspending Warnings</div>
                <ul className="list-disc ml-5 space-y-1">{warnings.map((w,i)=><li key={i}>{w}</li>)}</ul>
              </div>
            )}

            <div className="grid md:grid-cols-2 gap-4">
              <div className="p-4 border rounded-lg bg-white">
                <div className="font-medium mb-3">Net Worth Over Time</div>
                <NetWorthChart data={netWorthSeries} />
              </div>
              <div className="p-4 border rounded-lg bg-white">
                <div className="font-medium mb-3">Spending by Category (This Month)</div>
                <BarChart rows={categorySpend.map(c=>({name:c.name, spent:c.spent, budget:c.budget}))} />
              </div>
            </div>
          </div>
        );
      }

      function Budget(){
        return (
          <div className="space-y-4">
            <div className="flex items-center justify-between">
              <h2 className="text-lg font-semibold">Zero‚ÄëBased Monthly Budget ‚Äî {new Date(monthKey+'-01').toLocaleString(undefined,{month:'long', year:'numeric'})}</h2>
            </div>
            <div className="space-y-4">
              {groups.map(g=> (
                <div key={g.id} className="border rounded-lg bg-white overflow-hidden">
                  <div className="px-4 py-3 border-b font-medium bg-gradient-to-r from-indigo-50 to-white">{g.name}</div>
                  <div className="p-4 space-y-2">
                    {g.categories.map(c=>{
                      const spent = (categorySpend.find(x=>x.name===c.name)?.spent)||0;
                      const remaining = Number(c.budget||0)-spent;
                      return (
                        <div key={c.id} className="grid grid-cols-12 gap-2 items-center">
                          <div className="col-span-4">{c.name}</div>
                          <div className="col-span-3">
                            <label className="text-xs text-zinc-500">Planned</label>
                            <input type="number" value={c.budget} onChange={e=>updateCategoryBudget(c.id, e.target.value)} className="w-full mt-1 rounded-md border px-3 py-2"/>
                          </div>
                          <div className="col-span-2">
                            <div className="text-sm">Spent</div>
                            <div className="text-zinc-600">{currencyFmt(spent, profile.currency)}</div>
                          </div>
                          <div className={`col-span-3 font-medium ${remaining<0?'text-red-600':'text-emerald-700'}`}>{remaining<0?'Over by ':'Left '}{currencyFmt(Math.abs(remaining), profile.currency)}</div>
                        </div>
                      );
                    })}
                    <div className="pt-2"><AddCategoryButton onAdd={(name,budget)=>addCategory(g.id,name,budget)} /></div>
                  </div>
                </div>
              ))}
              <div className="flex gap-2">
                <Btn variant="outline" onClick={()=>{
                  const name = prompt('Group name?','New Group'); if(name) addGroup(name);
                }}>+ Add Category Group</Btn>
                <Btn variant="outline" onClick={exportCSV}>‚§ì Export CSV</Btn>
                <label className="border px-3 py-2 rounded-md text-sm cursor-pointer">
                  ‚§í Import CSV
                  <input type="file" accept=".csv" className="hidden" onChange={(e)=> e.target.files && importCSV(e.target.files[0]) } />
                </label>
              </div>
            </div>
          </div>
        );
      }

      function AddCategoryButton({onAdd}){
        return <Btn onClick={()=>{
          const name = prompt('Category name?','New Category');
          if(!name) return; const budget = Number(prompt('Monthly budget?','0')||0);
          onAdd(name, budget);
        }} variant="outline">+ Add Category</Btn>;
      }

      function Txns(){
        return (
          <div className="space-y-3">
            <div className="flex items-center justify-between">
              <h2 className="text-lg font-semibold">Transactions ‚Äî {new Date(monthKey+'-01').toLocaleString(undefined,{month:'long', year:'numeric'})}</h2>
            </div>
            <div className="p-4 border rounded-lg bg-white">
              <AddTxn onAdd={addTxn} />
            </div>
            <div className="border rounded-lg bg-white overflow-hidden">
              <div className="grid grid-cols-12 gap-2 px-4 py-3 border-b text-xs font-medium text-zinc-600">
                <div className="col-span-2">Date</div>
                <div className="col-span-2">Type</div>
                <div className="col-span-2">Account</div>
                <div className="col-span-4">Category / Note</div>
                <div className="col-span-2 text-right">Amount</div>
              </div>
              {monthTxns.length===0 && <div className="px-4 py-6 text-sm text-zinc-500">No transactions this month. Add one!</div>}
              {monthTxns.map(t=> (
                <div key={t.id} className="grid grid-cols-12 gap-2 px-4 py-3 border-t items-center">
                  <div className="col-span-2">{t.date}</div>
                  <div className="col-span-2 capitalize">{t.type}</div>
                  <div className="col-span-2">{accounts.find(a=>a.id===t.accountId)?.name || '‚Äî'}</div>
                  <div className="col-span-4 text-zinc-700">{(groups.flatMap(g=>g.categories).find(c=>c.id===t.categoryId)?.name)||'‚Äî'}{t.note?` ‚Äî ${t.note}`:''}</div>
                  <div className={`col-span-2 text-right ${t.type==='expense'?'text-red-600':'text-emerald-700'}`}>{t.type==='expense'?'-':'+'}{currencyFmt(t.amount, profile.currency)}</div>
                  <div className="col-span-12 text-right"><button onClick={()=>delTxn(t.id)} className="text-xs text-zinc-500 hover:text-red-600">Delete</button></div>
                </div>
              ))}
            </div>
          </div>
        );
      }

      function Accounts(){
        return (
          <div className="space-y-3">
            <div className="flex items-center justify-between">
              <h2 className="text-lg font-semibold">Accounts</h2>
              <Btn onClick={()=>{
                const name=prompt('Account name?','New Account'); if(!name) return;
                const type=prompt('Type? (Bank/Savings/Credit/Cash/Investment)','Bank')||'Bank';
                const balance=Number(prompt('Starting balance?','0')||0);
                addAccount({name,type,balance});
              }}>+ Add Account</Btn>
            </div>
            <div className="grid md:grid-cols-3 gap-4">
              {accounts.map(a=> (
                <div key={a.id} className="border-t-4 border-t-emerald-500 rounded-lg border bg-white">
                  <div className="p-4 flex items-center justify-between">
                    <div className="font-medium">{a.name}</div>
                    <button onClick={()=>delAccount(a.id)} className="text-sm text-zinc-500 hover:text-red-600">Delete</button>
                  </div>
                  <div className="px-4 pb-4 text-sm text-zinc-600">Type: {a.type}</div>
                  <div className="px-4 pb-4 text-2xl font-semibold">{currencyFmt(a.balance, profile.currency)}</div>
                </div>
              ))}
            </div>
          </div>
        );
      }

      function Bills(){
        return (
          <div className="space-y-3">
            <div className="flex items-center justify-between">
              <h2 className="text-lg font-semibold">Bills</h2>
              <Btn onClick={()=>{
                const name=prompt('Bill name?','Internet'); if(!name) return;
                const amount=Number(prompt('Amount?','0')||0);
                const dueDay=Math.max(1, Math.min(31, Number(prompt('Due day (1-31)?','1')||1)));
                const auto=confirm('Auto payment? OK=Yes, Cancel=No');
                addBill({name,amount,dueDay,auto});
              }}>+ Add Bill</Btn>
            </div>
            <div className="border rounded-lg bg-white overflow-hidden">
              <div className="grid grid-cols-12 gap-2 px-4 py-3 border-b text-xs font-medium text-zinc-600">
                <div className="col-span-4">Name</div>
                <div className="col-span-2">Amount</div>
                <div className="col-span-2">Due Day</div>
                <div className="col-span-2">Auto</div>
                <div className="col-span-2"></div>
              </div>
              {bills.map(b=> (
                <div key={b.id} className="grid grid-cols-12 gap-2 px-4 py-3 border-t items-center">
                  <div className="col-span-4">{b.name}</div>
                  <div className="col-span-2">{currencyFmt(b.amount, profile.currency)}</div>
                  <div className="col-span-2">{b.dueDay}</div>
                  <div className="col-span-2">{b.auto?'Yes':'No'}</div>
                  <div className="col-span-2 text-right"><button onClick={()=>delBill(b.id)} className="text-sm text-zinc-500 hover:text-red-600">Delete</button></div>
                </div>
              ))}
            </div>

            <div className="border rounded-lg bg-white">
              <div className="px-4 py-3 font-medium flex items-center gap-2">üìÖ Monthly Calendar</div>
              <div className="p-4 grid grid-cols-7 gap-2">
                {Array.from({length:31},(_,i)=>i+1).map(day=>{
                  const due = bills.filter(b=>b.dueDay===day);
                  const d = new Date(`${monthKey}-${String(day).padStart(2,'0')}`);
                  return (
                    <div key={day} className="border rounded-md p-2 min-h-[64px] bg-white/60">
                      <div className="text-xs text-zinc-500">{d.toLocaleString(undefined,{day:'numeric', month:'short'})}</div>
                      {due.map(b=> <div key={b.id} className="text-xs">‚Ä¢ {b.name} {currencyFmt(b.amount, profile.currency)}</div>)}
                    </div>
                  );
                })}
              </div>
            </div>
          </div>
        );
      }

      function Goals(){
        return (
          <div className="space-y-3">
            <div className="flex items-center justify-between">
              <h2 className="text-lg font-semibold">Savings & Debt Goals</h2>
              <Btn onClick={()=>{
                const name=prompt('Goal name?','Emergency Fund'); if(!name) return;
                const target=Number(prompt('Target?','1000')||0);
                const saved=Number(prompt('Initial saved?','0')||0);
                const deadline=prompt('Deadline (YYYY-MM-DD)?', new Date().getFullYear()+'-12-31')||todayISO();
                addGoal({name,target,saved,deadline});
              }}>+ Add Goal</Btn>
            </div>
            <div className="grid md:grid-cols-2 gap-4">
              {goals.map(g=>{
                const pct = Math.min(100, Math.round((Number(g.saved||0)/Math.max(1,Number(g.target||1)))*100));
                return (
                  <div key={g.id} className="border rounded-lg bg-white p-4">
                    <div className="flex items-center justify-between">
                      <div className="font-medium">üéØ {g.name}</div>
                      <button onClick={()=>delGoal(g.id)} className="text-sm text-zinc-500 hover:text-red-600">Delete</button>
                    </div>
                    <div className="text-sm text-zinc-600 mt-1">Deadline: {g.deadline}</div>
                    <div className="h-3 bg-zinc-100 rounded-full overflow-hidden mt-3">
                      <div className="h-full bg-gradient-to-r from-rose-500 to-pink-600" style={{width:pct+'%'}}></div>
                    </div>
                    <div className="flex justify-between text-sm mt-2">
                      <div>Saved: {currencyFmt(g.saved, profile.currency)}</div>
                      <div>Target: {currencyFmt(g.target, profile.currency)}</div>
                    </div>
                    <div className="mt-3 flex gap-2">
                      <input type="number" placeholder="Add amount" className="flex-1 rounded-md border px-3 py-2" onKeyDown={(e)=>{
                        if(e.key==='Enter'){
                          const val=Number(e.currentTarget.value||0); updateGoal(g.id, {saved:Number(g.saved||0)+val}); e.currentTarget.value='';
                        }
                      }} />
                      <Btn variant="outline" onClick={()=>updateGoal(g.id,{saved:0})}>Reset</Btn>
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
        );
      }

      function RecurringTab(){
        return (
          <div className="space-y-3">
            <div className="flex items-center justify-between">
              <h2 className="text-lg font-semibold">‚ôªÔ∏è Recurring Monthly Transactions</h2>
              <Btn onClick={()=>{
                const name=prompt('Name?','Salary / Gym'); if(!name) return;
                const type=prompt('Type: income or expense','expense')||'expense';
                const amount=Number(prompt('Amount?','0')||0);
                const dayOfMonth=Math.max(1, Math.min(31, Number(prompt('Day of month (1-31)?','1')||1)));
                const accountId=(accounts[0]?.id)||'';
                const categoryId = prompt('Category id (optional). Leave blank if none','')||undefined;
                const note = prompt('Note (optional)','')||'';
                addRecurring({name,type,amount,dayOfMonth,accountId,categoryId,note,isEnabled:true});
              }}>+ Add Recurring</Btn>
            </div>
            <div className="border rounded-lg bg-white overflow-hidden">
              <div className="grid grid-cols-12 gap-2 px-4 py-3 border-b text-xs font-medium text-zinc-600">
                <div className="col-span-3">Name</div>
                <div className="col-span-1">Type</div>
                <div className="col-span-2">Amount</div>
                <div className="col-span-2">Day</div>
                <div className="col-span-2">Account</div>
                <div className="col-span-1">Enabled</div>
                <div className="col-span-1"></div>
              </div>
              {recurring.length===0 && <div className="px-4 py-6 text-sm text-zinc-500">No recurring rules yet. Add one!</div>}
              {recurring.map(r=> (
                <div key={r.id} className="grid grid-cols-12 gap-2 px-4 py-3 border-t items-center">
                  <div className="col-span-3">{r.name}{r.note?` ‚Äî ${r.note}`:''}</div>
                  <div className="col-span-1 capitalize">{r.type}</div>
                  <div className="col-span-2">{currencyFmt(r.amount, profile.currency)}</div>
                  <div className="col-span-2">{r.dayOfMonth}</div>
                  <div className="col-span-2">{accounts.find(a=>a.id===r.accountId)?.name || '‚Äî'}</div>
                  <div className="col-span-1"><input type="checkbox" checked={!!r.isEnabled} onChange={e=>updateRecurring(r.id,{isEnabled:e.target.checked})} /></div>
                  <div className="col-span-1 text-right"><button onClick={()=>delRecurring(r.id)} className="text-sm text-zinc-500 hover:text-red-600">Delete</button></div>
                </div>
              ))}
            </div>
            <div className="border-l-4 border-l-sky-500 bg-white p-4 rounded-lg">
              <div className="font-medium mb-1">How it works</div>
              <p className="text-sm text-zinc-600">Each month you select at the top, enabled recurring items are auto-created on their set day. If an item for that day already exists (same rule), it won't be duplicated. Months with fewer days clamp to the last day (e.g., 31st ‚Üí 30th/28th).</p>
            </div>
          </div>
        );
      }

      function Categories(){
        return (
          <div className="space-y-3">
            <h2 className="text-lg font-semibold">Categories & Groups</h2>
            <div className="space-y-4">
              {groups.map(g=> (
                <div key={g.id} className="border rounded-lg bg-white">
                  <div className="px-4 py-3 border-b font-medium">{g.name}</div>
                  <div className="p-4 space-y-2">
                    <div className="grid grid-cols-12 gap-2 text-xs text-zinc-600">
                      <div className="col-span-6">Category</div>
                      <div className="col-span-3">Budget</div>
                      <div className="col-span-3"></div>
                    </div>
                    {g.categories.map(c=> (
                      <div key={c.id} className="grid grid-cols-12 gap-2 items-center">
                        <div className="col-span-6">{c.name}</div>
                        <div className="col-span-3">{currencyFmt(c.budget, profile.currency)}</div>
                        <div className="col-span-3 text-right"><button onClick={()=>delCategory(c.id)} className="text-sm text-zinc-500 hover:text-red-600">Delete</button></div>
                      </div>
                    ))}
                    <AddCategoryButton onAdd={(name,budget)=>addCategory(g.id,name,budget)} />
                  </div>
                </div>
              ))}
            </div>
          </div>
        );
      }

      // Card helper
      function Card({title, value, color}){
        return (
          <div className="rounded-lg overflow-hidden border shadow-sm">
            <div className={`px-4 py-2 text-sm font-medium text-white bg-gradient-to-r ${color}`}>{title}</div>
            <div className="px-4 py-3 bg-white text-2xl font-semibold">{value}</div>
          </div>
        );
      }

      // Self-tests (console)
      useEffect(()=>{
        try{
          console.assert(sanitizeNote('a\nb')==='a b','Sanitize newlines');
          console.assert(daysInMonth(2025,2)===28,'Feb 2025 days');
          const esc = csvEscape('a,b'); console.assert(/^".*"$/.test(esc),'CSV quote');
          const round = parseCSVLine(['a','b,c','d"e'].map(csvEscape).join(','));
          console.assert(round[1]==='b,c' && round[2]==='d"e', 'CSV roundtrip');
          console.log('MyFinance single-file self-tests ‚úî');
        }catch(e){ console.error('Self-tests failed', e); }
      },[]);

      return (
        <div>
          <header className="flex items-center justify-between mb-6">
            <div>
              <h1 className="text-3xl font-semibold bg-gradient-to-r from-indigo-600 via-fuchsia-600 to-rose-500 bg-clip-text text-transparent">MyFinance</h1>
              <p className="text-sm text-zinc-600">Zero-based budgeting ‚Ä¢ CSV import/export ‚Ä¢ Local only ‚Ä¢ Recurring monthly</p>
            </div>
            <div className="flex items-center gap-2">
              <input type="month" value={profile.month} onChange={e=>setProfile({...profile, month:e.target.value})}
                className="w-[150px] rounded-md border px-3 py-2" />
              <input type="text" value={profile.currency} onChange={e=>setProfile({...profile, currency:e.target.value})} maxLength={3}
                className="w-[80px] rounded-md border px-3 py-2" title="Currency symbol"/>
            </div>
          </header>

          <nav className="flex flex-wrap gap-2 mb-6">
            {[
              ['dashboard','Dashboard'], ['budget','Budget'], ['transactions','Transactions'],
              ['accounts','Accounts'], ['bills','Bills'], ['goals','Goals'], ['recurring','Recurring'], ['settings','Categories']
            ].map(([k,label])=> (
              <button key={k} onClick={()=>setTab(k)} className={`px-3 py-2 rounded-md text-sm ${tab===k?'bg-indigo-600 text-white':'bg-white border'}`}>{label}</button>
            ))}
          </nav>

          {tab==='dashboard' && <Dashboard/>}
          {tab==='budget' && <Budget/>}
          {tab==='transactions' && <Txns/>}
          {tab==='accounts' && <Accounts/>}
          {tab==='bills' && <Bills/>}
          {tab==='goals' && <Goals/>}
          {tab==='recurring' && <RecurringTab/>}
          {tab==='settings' && <Categories/>}

          <footer className="mt-10 text-xs text-zinc-500">Built with ‚ô•. Data stays in your browser (localStorage). Use on GitHub Pages freely.</footer>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
  </script>
</body>
</html>
